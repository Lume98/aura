---
import Layout from '../layouts/Layout.astro';
import { getCollection } from 'astro:content';

const allPrompts = await getCollection('prompts');
const recentPrompts = allPrompts.sort((a, b) => (b.data.date?.valueOf() || 0) - (a.data.date?.valueOf() || 0)).slice(0, 3);
const categories = [...new Set(allPrompts.map(p => p.data.category))];
---

<Layout title="工作区">
	<div class="max-w-7xl mx-auto -mt-4 md:-mt-8">
		<!-- Main IDE-like Window -->
		<div class="bg-white border border-slate-200 rounded-2xl shadow-2xl overflow-hidden flex flex-col md:flex-row h-[calc(100vh-160px)] min-h-[600px]">
			<!-- Sidebar -->
			<aside class="w-full md:w-64 border-r border-slate-100 bg-[#ebeae6] flex flex-col shrink-0">
				<div class="p-4 border-b border-slate-100 flex items-center justify-between bg-white/50 backdrop-blur-sm sticky top-0 z-10">
					<div class="flex items-center gap-2">
						<div class="flex gap-1">
							<div class="w-2.5 h-2.5 rounded-full bg-[#ff5f57]"></div>
							<div class="w-2.5 h-2.5 rounded-full bg-[#febc2e]"></div>
							<div class="w-2.5 h-2.5 rounded-full bg-[#28c840]"></div>
						</div>
						<span class="text-[11px] font-bold text-slate-400 ml-2 tracking-tight uppercase">Workspace</span>
					</div>
				</div>

				<div class="flex-grow overflow-y-auto py-4 scrollbar-hide">
					<!-- Section: Tasks -->
					<div class="px-4 mb-8">
						<h3 class="text-[10px] font-black text-slate-400 uppercase tracking-[0.2em] mb-4 px-2 flex items-center gap-2">
							<span class="text-xs">※</span>
							进行中 {recentPrompts.length}
						</h3>
						<div class="space-y-1">
							{recentPrompts.map(prompt => (
								<div class="group px-3 py-2.5 rounded-xl hover:bg-white hover:shadow-sm cursor-pointer transition-all duration-200 border border-transparent hover:border-slate-100">
									<div class="flex items-start gap-3">
										<div class="mt-1 w-3.5 h-3.5 rounded-full border-2 border-indigo-500/20 flex items-center justify-center shrink-0">
											<div class="w-1 h-1 bg-indigo-500 rounded-full animate-pulse"></div>
										</div>
										<div class="min-w-0 flex-grow">
											<div class="text-[12px] font-bold text-slate-700 truncate group-hover:text-indigo-600 leading-tight mb-0.5">{prompt.data.title}</div>
											<div class="flex items-center justify-between">
												<div class="text-[10px] text-slate-400 truncate opacity-80 font-medium">生成中...</div>
												<div class="text-[9px] font-bold text-indigo-500/60 tabular-nums">+162 -37</div>
											</div>
										</div>
									</div>
								</div>
							))}
						</div>
					</div>

					<!-- Section: Categories -->
					<div class="px-4">
						<h3 class="text-[10px] font-black text-slate-400 uppercase tracking-[0.2em] mb-4 px-2 flex items-center gap-2">
							<span class="text-xs"></span>
							准备审查 {categories.length}
						</h3>
						<div class="space-y-1">
							{categories.map(cat => (
								<div class="flex items-center gap-2.5 px-3 py-2 rounded-lg hover:bg-white cursor-pointer transition-all group border border-transparent hover:border-slate-100">
									<svg xmlns="http://www.w3.org/2000/svg" class="w-3.5 h-3.5 text-slate-300 group-hover:text-indigo-400 transition-colors" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
									<span class="text-[12px] text-slate-600 group-hover:text-slate-900 truncate font-medium">{cat}</span>
								</div>
							))}
						</div>
					</div>
				</div>

				<div class="p-4 border-t border-slate-100 bg-white/50 backdrop-blur-sm text-[11px] text-slate-400 flex justify-between items-center">
					<div class="flex items-center gap-2">
						<div class="w-1.5 h-1.5 rounded-full bg-green-500"></div>
						<span class="font-medium tracking-tight">GPT-5.2</span>
					</div>
					<kbd class="px-1.5 py-0.5 bg-slate-50 border border-slate-200 rounded text-[9px] font-mono">⌘ K</kbd>
				</div>
			</aside>

			<!-- Main Chat & Editor Area -->
			<div class="flex-grow flex flex-col md:flex-row min-w-0">
				<!-- Chat Panel -->
				<main class="flex-grow flex flex-col bg-white min-w-0 md:max-w-2xl border-r border-slate-50">
					<div class="flex-grow overflow-y-auto p-6 md:p-10 space-y-10 scrollbar-hide">
						<!-- User Request -->
						<div class="max-w-2xl">
							<h1 class="text-xl font-bold text-slate-900 mb-6 tracking-tight">PyTorch MNIST 实验</h1>
							<div class="bg-[#fcfdfe] border border-slate-100 rounded-2xl p-6 shadow-sm ring-1 ring-slate-200/5">
								<p class="text-[14px] text-slate-600 leading-relaxed font-medium">
									添加混合精度训练、学习率调度和适当的验证。同时创建一个实验配置系统，以便我可以轻松运行不同的超参数设置。
								</p>
								<div class="mt-4 pt-4 border-t border-slate-50 flex items-center gap-2">
									<svg xmlns="http://www.w3.org/2000/svg" class="w-3.5 h-3.5 text-slate-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a4 4 0 0 0-4-4H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a4 4 0 0 1 4-4h6z"/></svg>
									<span class="text-[11px] text-slate-400 font-medium tracking-tight">读取 <span class="text-indigo-500/80 underline decoration-indigo-500/20 underline-offset-4 cursor-pointer">notebooks/train_model.py</span> (当前实现)</span>
								</div>
							</div>
						</div>

						<!-- Agent Response -->
						<div class="max-w-2xl">
							<div class="flex items-center gap-2.5 mb-5">
								<div class="w-7 h-7 bg-indigo-600 rounded-lg flex items-center justify-center text-[11px] text-white font-black tracking-tighter">AI</div>
								<span class="text-[13px] font-bold text-slate-800 tracking-tight">Cursor Agent</span>
							</div>
							<div class="space-y-6">
								<p class="text-[14px] text-slate-600 leading-relaxed">
									我将为您当前的提示词增强一个完整的实验框架，包括混合精度训练、验证集划分和适当的配置管理。让我先重写训练模块：
								</p>

								<!-- Action: File Edit Card -->
								<div class="group border border-slate-100 rounded-xl p-4 flex items-center justify-between bg-[#fcfdfe] hover:bg-white hover:shadow-md hover:border-indigo-100 transition-all duration-300 cursor-pointer">
									<div class="flex items-center gap-4 min-w-0">
										<div class="w-9 h-9 rounded-lg bg-indigo-50 flex items-center justify-center text-indigo-500 group-hover:scale-110 transition-transform">
											<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path><polyline points="14 2 14 8 20 8"></polyline></svg>
										</div>
										<div class="min-w-0">
											<div class="text-[13px] font-bold text-slate-700 truncate mb-0.5">train_model.py</div>
											<div class="text-[11px] font-bold text-indigo-500/80 tabular-nums">+156 -34</div>
										</div>
									</div>
									<svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-slate-300 group-hover:text-indigo-400 group-hover:translate-x-1 transition-all" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg>
								</div>

								<p class="text-[14px] text-slate-600 leading-relaxed font-medium">现在让我更新评估模块以保存结果并生成详细报告：</p>

								<div class="group border border-slate-100 rounded-xl p-4 flex items-center justify-between bg-[#fcfdfe] hover:bg-white hover:shadow-md hover:border-indigo-100 transition-all duration-300 cursor-pointer">
									<div class="flex items-center gap-4 min-w-0">
										<div class="w-9 h-9 rounded-lg bg-green-50 flex items-center justify-center text-green-500 group-hover:scale-110 transition-transform">
											<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><line x1="10" y1="9" x2="8" y2="9"/></svg>
										</div>
										<div class="min-w-0">
											<div class="text-[13px] font-bold text-slate-700 truncate mb-0.5">evaluation.py</div>
											<div class="text-[11px] font-bold text-indigo-500/80 tabular-nums">+24 -6</div>
										</div>
									</div>
									<svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-slate-300 group-hover:text-indigo-400 group-hover:translate-x-1 transition-all" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg>
								</div>

								<div class="bg-indigo-50/50 border border-indigo-100/50 rounded-xl p-5 text-[13px] text-indigo-900 leading-relaxed italic">
									完成，可配置的 MNIST 实验框架，支持 AMP 和报告生成。 • 训练: AMP、训练/验证集划分、余弦调度、梯度裁剪、检查点 • 实验: YAML 配置、保存历史记录、混淆矩阵 + 分类报告、CLI 运行器
								</div>
							</div>
						</div>
					</div>

					<!-- Input Area -->
					<div class="p-6 md:p-8 bg-white/80 backdrop-blur-md border-t border-slate-50 sticky bottom-0">
						<div class="relative group">
							<div class="absolute -inset-0.5 bg-gradient-to-r from-indigo-500/10 to-blue-500/10 rounded-2xl blur opacity-0 group-focus-within:opacity-100 transition duration-500"></div>
							<div class="relative bg-white border border-slate-200 rounded-2xl p-2 flex items-end gap-3 transition-all duration-300 group-focus-within:border-indigo-400 group-focus-within:shadow-lg">
								<textarea 
									class="flex-grow bg-transparent border-none focus:ring-0 text-[14px] text-slate-700 px-4 py-3 resize-none h-14 max-h-40 placeholder:text-slate-400 font-medium"
									placeholder="规划、搜索、构建任何内容..."
								></textarea>
								<div class="flex items-center gap-2 pr-2 pb-2">
									<div class="flex items-center gap-1.5 px-2 py-1 bg-slate-50 border border-slate-100 rounded text-[10px] font-bold text-slate-400">
										<span class="font-mono">GPT-5.2</span>
									</div>
									<button class="bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl p-2.5 transition-all active:scale-95 shadow-lg shadow-indigo-200">
										<svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="m5 12 7-7 7 7"/><path d="M12 19V5"/></svg>
									</button>
								</div>
							</div>
						</div>
						<div class="mt-4 flex items-center justify-center gap-4 text-[11px] font-bold text-slate-300 uppercase tracking-widest">
							<span>/ 用于命令</span>
							<span class="text-slate-200">•</span>
							<span>@ 用于文件</span>
						</div>
					</div>
				</main>

				<!-- Editor/Diff Panel -->
				<div class="hidden lg:flex flex-col flex-grow bg-[#f2f1ed]/30 min-w-0">
					<div class="h-14 flex items-center px-4 bg-white border-b border-slate-100 gap-1 overflow-x-auto scrollbar-hide">
						<div class="flex items-center gap-2 px-3 py-1.5 rounded-lg bg-[#ebeae6] border border-slate-100 shrink-0">
							<div class="w-3 h-3 text-indigo-500">
								<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/></svg>
							</div>
							<span class="text-[12px] font-bold text-slate-700">train_model.py</span>
							<div class="w-1.5 h-1.5 rounded-full bg-indigo-500 ml-1"></div>
						</div>
						<div class="flex items-center gap-2 px-3 py-1.5 rounded-lg hover:bg-slate-50 shrink-0 cursor-pointer">
							<span class="text-[12px] font-medium text-slate-400">evaluation.py</span>
						</div>
						<div class="flex items-center gap-2 px-3 py-1.5 rounded-lg hover:bg-slate-50 shrink-0 cursor-pointer">
							<span class="text-[12px] font-medium text-slate-400">config.yaml</span>
						</div>
					</div>
					
					<div class="flex-grow p-6 font-mono text-[13px] leading-[1.8] overflow-y-auto scrollbar-hide">
						<div class="space-y-0.5">
							<div class="flex gap-6 group">
								<span class="w-8 text-right text-slate-300 select-none font-sans">1</span>
								<span class="text-indigo-600/80">import</span> <span class="text-slate-700">torch</span>
							</div>
							<div class="flex gap-6 group">
								<span class="w-8 text-right text-slate-300 select-none font-sans">2</span>
								<span class="text-indigo-600/80">import</span> <span class="text-slate-700">torch.nn</span> <span class="text-indigo-600/80">as</span> <span class="text-slate-700">nn</span>
							</div>
							<div class="flex gap-6 bg-red-50/80 -mx-6 px-6 border-l-4 border-red-500/50 group">
								<span class="w-8 text-right text-red-300 select-none font-sans group-hover:text-red-400">-</span>
								<span class="text-slate-700 opacity-60 italic">from torch.utils.data import DataLoader</span>
							</div>
							<div class="flex gap-6 bg-green-50/80 -mx-6 px-6 border-l-4 border-green-500/50 group">
								<span class="w-8 text-right text-green-400 select-none font-sans">+</span>
								<span class="text-slate-700">from torch.utils.data import DataLoader, random_split</span>
							</div>
							<div class="flex gap-6 bg-red-50/80 -mx-6 px-6 border-l-4 border-red-500/50 group">
								<span class="w-8 text-right text-red-300 select-none font-sans group-hover:text-red-400">-</span>
								<span class="text-slate-700 opacity-60 italic">from torchvision import datasets</span>
							</div>
							<div class="flex gap-6 bg-green-50/80 -mx-6 px-6 border-l-4 border-green-500/50 group">
								<span class="w-8 text-right text-green-400 select-none font-sans">+</span>
								<span class="text-slate-700">from torchvision import datasets, transforms</span>
							</div>
							<div class="flex gap-6 bg-green-50/80 -mx-6 px-6 border-l-4 border-green-500/50 group">
								<span class="w-8 text-right text-green-400 select-none font-sans">+</span>
								<span class="text-indigo-600/80">from</span> <span class="text-slate-700">tqdm</span> <span class="text-indigo-600/80">import</span> <span class="text-slate-700">tqdm</span>
							</div>
							<div class="flex gap-6 bg-green-50/80 -mx-6 px-6 border-l-4 border-green-500/50 group">
								<span class="w-8 text-right text-green-400 select-none font-sans">+</span>
								<span class="text-indigo-600/80">import</span> <span class="text-slate-700">yaml</span>
							</div>
							<div class="flex gap-6 group">
								<span class="w-8 text-right text-slate-300 select-none font-sans">9</span>
								<span class="text-slate-400 italic"># ... 更多代码 ...</span>
							</div>
						</div>
					</div>

					<div class="p-4 bg-white border-t border-slate-100 flex items-center justify-between shadow-[0_-4px_20px_rgba(0,0,0,0.02)]">
						<div class="flex items-center gap-4">
							<div class="flex -space-x-2">
								<div class="w-6 h-6 rounded-full border-2 border-white bg-indigo-500 flex items-center justify-center text-[8px] text-white">AI</div>
								<div class="w-6 h-6 rounded-full border-2 border-white bg-slate-200 flex items-center justify-center text-[8px] text-slate-400 italic">ME</div>
							</div>
							<span class="text-[11px] font-bold text-slate-400 uppercase tracking-widest">协作模式</span>
						</div>
						<button class="text-[12px] font-bold text-indigo-600 hover:bg-indigo-50 px-3 py-1.5 rounded-lg transition-colors">
							全部接受
						</button>
					</div>
				</div>
			</div>
		</div>

		<!-- Subtle Background Accents -->
		<div class="fixed top-1/4 -left-64 w-[500px] h-[500px] bg-indigo-500/5 rounded-full blur-[120px] -z-10 animate-pulse"></div>
		<div class="fixed bottom-1/4 -right-64 w-[500px] h-[500px] bg-blue-500/5 rounded-full blur-[120px] -z-10"></div>
	</div>
</Layout>

<style>
	.scrollbar-hide::-webkit-scrollbar {
		display: none;
	}
	.scrollbar-hide {
		-ms-overflow-style: none;
		scrollbar-width: none;
	}
</style>
